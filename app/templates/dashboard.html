{% extends "base.html" %}

{% block title %}Dashboard - VersatilesPrint{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row mb-4">
        <div class="col">
            <h1>
                <i class="bi bi-speedometer2"></i> Dashboard
                <small class="text-muted">Welcome, {{ current_user.full_name or current_user.email }}</small>
            </h1>
            <p class="text-muted">
                Role: 
                {% if current_user.is_admin %}
                    <span class="badge bg-danger">Administrator</span>
                {% elif current_user.is_agent %}
                    <span class="badge bg-info">Agent</span>
                {% elif current_user.is_client %}
                    <span class="badge bg-success">Client</span>
                {% endif %}
            </p>
        </div>
    </div>

    {% if current_user.is_client %}
    <!-- Client Dashboard -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-bar-chart"></i> My Quota</h5>
                    <div id="quotaInfo">
                        <p class="text-muted">Loading quota information...</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-file-text"></i> Quick Stats</h5>
                    <div id="statsInfo">
                        <p class="text-muted">Loading statistics...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-plus-circle"></i> Create New Order</h5>
        </div>
        <div class="card-body">
            <form id="createOrderForm">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="bwCount" class="form-label">Black & White Prints</label>
                        <input type="number" class="form-control" id="bwCount" name="bw_count" min="0" value="0">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="colorCount" class="form-label">Color Prints</label>
                        <input type="number" class="form-control" id="colorCount" name="color_count" min="0" value="0">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="paperDimensions" class="form-label">Paper Size</label>
                        <select class="form-select" id="paperDimensions" name="paper_dimensions">
                            <option value="A4">A4</option>
                            <option value="A3">A3</option>
                            <option value="Letter">Letter</option>
                            <option value="Legal">Legal</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="orientation" class="form-label">Orientation</label>
                        <select class="form-select" id="orientation" name="orientation">
                            <option value="portrait">Portrait</option>
                            <option value="landscape">Landscape</option>
                        </select>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="additionalOptions" class="form-label">Additional Options</label>
                    <textarea class="form-control" id="additionalOptions" name="additional_options" rows="2" placeholder="Any special instructions..."></textarea>
                </div>
                <div id="orderError" class="alert alert-danger d-none"></div>
                <button type="submit" class="btn btn-primary" id="createOrderBtn">
                    <i class="bi bi-plus-circle"></i> Create Order
                </button>
            </form>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-list-ul"></i> My Orders</h5>
        </div>
        <div class="card-body">
            <div id="ordersTable">
                <p class="text-muted">Loading orders...</p>
            </div>
        </div>
    </div>

    {% elif current_user.is_agent %}
    <!-- Agent Dashboard -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card">
                <div class="card-body text-center">
                    <h3 class="text-primary" id="activeOrdersCount">0</h3>
                    <p class="text-muted">Active Orders</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body text-center">
                    <h3 class="text-success" id="completedOrdersCount">0</h3>
                    <p class="text-muted">Completed Orders</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body text-center">
                    <h3 class="text-info" id="workloadCapacity">0/10</h3>
                    <p class="text-muted">Workload Capacity</p>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-list-check"></i> Assigned Orders</h5>
        </div>
        <div class="card-body">
            <div id="agentOrdersTable">
                <p class="text-muted">Loading orders...</p>
            </div>
        </div>
    </div>

    {% elif current_user.is_admin %}
    <!-- Admin Dashboard -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <h3 class="text-primary" id="totalUsers">0</h3>
                    <p class="text-muted">Total Users</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <h3 class="text-info" id="totalOrders">0</h3>
                    <p class="text-muted">Total Orders</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <h3 class="text-warning" id="pendingCSV">0</h3>
                    <p class="text-muted">Pending CSV</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <h3 class="text-success" id="activeClients">0</h3>
                    <p class="text-muted">Active Clients</p>
                </div>
            </div>
        </div>
    </div>

    <ul class="nav nav-tabs mb-3" id="adminTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders" type="button">
                <i class="bi bi-file-text"></i> All Orders
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button">
                <i class="bi bi-people"></i> Users
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="csv-tab" data-bs-toggle="tab" data-bs-target="#csv" type="button">
                <i class="bi bi-file-earmark-spreadsheet"></i> CSV Imports
            </button>
        </li>
    </ul>

    <div class="tab-content" id="adminTabsContent">
        <div class="tab-pane fade show active" id="orders" role="tabpanel">
            <div class="card">
                <div class="card-body">
                    <div id="allOrdersTable">
                        <p class="text-muted">Loading orders...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="tab-pane fade" id="users" role="tabpanel">
            <div class="card">
                <div class="card-body">
                    <button class="btn btn-primary mb-3" onclick="openUserModal()">
                        <i class="bi bi-plus-circle"></i> Add New User
                    </button>
                    <div id="usersTable">
                        <p class="text-muted">Loading users...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="tab-pane fade" id="csv" role="tabpanel">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex gap-2 mb-3">
                        <button class="btn btn-primary" onclick="openCsvModal()">
                            <i class="bi bi-upload"></i> Upload CSV
                        </button>
                        <button class="btn btn-success" onclick="openTopupModal()">
                            <i class="bi bi-plus-circle"></i> Add Quota Top-up
                        </button>
                    </div>
                    <div id="csvImportsTable">
                        <p class="text-muted">Loading CSV imports...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Include Modals -->
{% include 'components/modals.html' %}

{% endblock %}

{% block extra_js %}
<!-- Load Components Library -->
<script src="{{ url_for('static', filename='js/components.js') }}"></script>

<script>
// Load dashboard data based on role
{% if current_user.is_client %}
// Load client quota
fetch('/api/quotas')
    .then(r => r.json())
    .then(response => {
        console.log('Quota API response:', response);
        const quota = response.data || response;
        
        // API returns {data: {bw: {available, total_limit, percentage_used}, color: {...}}}
        if (quota && quota.bw && quota.color) {
            const bwPercentage = quota.bw.percentage_used || 0;
            const colorPercentage = quota.color.percentage_used || 0;
            const bwUsed = quota.bw.total_limit - quota.bw.available;
            const colorUsed = quota.color.total_limit - quota.color.available;
            
            document.getElementById('quotaInfo').innerHTML = `
                <p><strong>B&W:</strong> ${bwUsed} / ${quota.bw.total_limit} prints (${bwPercentage.toFixed(1)}% used)</p>
                <div class="progress mb-2" style="height: 20px;">
                    <div class="progress-bar ${bwPercentage > 80 ? 'bg-danger' : bwPercentage > 60 ? 'bg-warning' : ''}" 
                         role="progressbar" 
                         style="width: ${bwPercentage}%"
                         aria-valuenow="${bwPercentage}" 
                         aria-valuemin="0" 
                         aria-valuemax="100">
                        ${bwPercentage.toFixed(1)}%
                    </div>
                </div>
                <p class="mt-3"><strong>Color:</strong> ${colorUsed} / ${quota.color.total_limit} prints (${colorPercentage.toFixed(1)}% used)</p>
                <div class="progress" style="height: 20px;">
                    <div class="progress-bar bg-info ${colorPercentage > 80 ? 'bg-danger' : colorPercentage > 60 ? 'bg-warning' : ''}" 
                         role="progressbar" 
                         style="width: ${colorPercentage}%"
                         aria-valuenow="${colorPercentage}" 
                         aria-valuemin="0" 
                         aria-valuemax="100">
                        ${colorPercentage.toFixed(1)}%
                    </div>
                </div>
                ${bwPercentage > 80 || colorPercentage > 80 ? '<p class="text-danger mt-2"><small><i class="bi bi-exclamation-triangle"></i> Low quota! Consider requesting a top-up.</small></p>' : ''}
            `;
        } else {
            document.getElementById('quotaInfo').innerHTML = '<p class="text-warning">No quota information available.</p>';
        }
    })
    .catch(error => {
        console.error('Error loading quota:', error);
        document.getElementById('quotaInfo').innerHTML = '<div class="alert alert-danger">Failed to load quota information</div>';
    });

// Load client orders
fetch('/api/orders')
    .then(r => r.json())
    .then(response => {
        console.log('Orders API response:', response);
        const data = response.data || response;
        const orders = data.items || [];
        
        if (orders && orders.length > 0) {
            const thisMonth = new Date().getMonth();
            const thisMonthOrders = orders.filter(o => new Date(o.created_at).getMonth() === thisMonth);
            
            document.getElementById('ordersTable').innerHTML = `
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>B&W</th>
                            <th>Color</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${orders.map(o => `
                            <tr class="clickable" onclick="viewOrderDetails(${o.id})">
                                <td>#${o.id}</td>
                                <td>${o.bw_quantity || o.bw_count || 0}</td>
                                <td>${o.color_quantity || o.color_count || 0}</td>
                                <td><span class="badge bg-${o.status === 'completed' ? 'success' : o.status === 'processing' ? 'primary' : 'warning'}">${o.status}</span></td>
                                <td>${new Date(o.created_at).toLocaleDateString()}</td>
                                <td><button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); viewOrderDetails(${o.id})"><i class="bi bi-eye"></i></button></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            document.getElementById('statsInfo').innerHTML = `
                <p><strong>Total Orders:</strong> ${data.pagination?.total_items || data.items.length}</p>
                <p><strong>This Month:</strong> ${thisMonthOrders.length}</p>
                <p><strong>Pending:</strong> ${data.items.filter(o => o.status === 'pending').length}</p>
                <p><strong>Completed:</strong> ${data.items.filter(o => o.status === 'completed').length}</p>
            `;
        } else {
            document.getElementById('ordersTable').innerHTML = '<p class="text-muted">No orders yet. Create your first order above!</p>';
            document.getElementById('statsInfo').innerHTML = '<p class="text-muted">No order statistics available.</p>';
        }
    })
    .catch(error => {
        console.error('Error loading orders:', error);
        document.getElementById('ordersTable').innerHTML = '<div class="alert alert-danger">Failed to load orders</div>';
        document.getElementById('statsInfo').innerHTML = '<div class="alert alert-danger">Failed to load statistics</div>';
    });

// Handle order creation
document.getElementById('createOrderForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const bwCount = parseInt(document.getElementById('bwCount').value) || 0;
    const colorCount = parseInt(document.getElementById('colorCount').value) || 0;
    
    // Validate at least one quantity
    if (bwCount === 0 && colorCount === 0) {
        document.getElementById('orderError').textContent = 'Please specify at least one print quantity (B&W or Color).';
        document.getElementById('orderError').classList.remove('d-none');
        return;
    }
    
    const formData = {
        bw_quantity: bwCount,
        color_quantity: colorCount,
        paper_dimensions: document.getElementById('paperDimensions').value || null,
        notes: document.getElementById('additionalOptions').value || null
    };
    
    const btn = document.getElementById('createOrderBtn');
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'Creating...';
    
    try {
        const response = await fetch('/api/orders', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        console.log('Create order response:', result);
        
        if (response.ok) {
            alert('Order created successfully!');
            document.getElementById('createOrderForm').reset();
            document.getElementById('orderError').classList.add('d-none');
            // Close modal if using Bootstrap modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('createOrderModal'));
            if (modal) modal.hide();
            window.location.reload();
        } else {
            // Extract error message from response
            let errorMsg = result.message || 'Failed to create order';
            if (result.errors && Array.isArray(result.errors)) {
                errorMsg += ': ' + result.errors.join(', ');
            }
            document.getElementById('orderError').textContent = errorMsg;
            document.getElementById('orderError').classList.remove('d-none');
        }
    } catch (err) {
        console.error('Order creation error:', err);
        document.getElementById('orderError').textContent = 'Network error. Please try again.';
        document.getElementById('orderError').classList.remove('d-none');
    } finally {
        btn.disabled = false;
        btn.textContent = originalText;
    }
});
{% endif %}

{% if current_user.is_agent %}
// Load agent orders
fetch('/api/orders')
    .then(r => r.json())
    .then(response => {
        console.log('Agent Orders API response:', response);
        const data = response.data || response;
        const orders = data.items || [];
        
        if (orders && orders.length > 0) {
            const active = orders.filter(o => ['pending', 'validated', 'processing'].includes(o.status));
            const completed = orders.filter(o => o.status === 'completed');
            const maxCapacity = 10; // Could be fetched from config
            
            document.getElementById('activeOrdersCount').textContent = active.length;
            document.getElementById('completedOrdersCount').textContent = completed.length;
            document.getElementById('workloadCapacity').textContent = `${active.length}/${maxCapacity}`;
            
            // Update capacity card color based on workload
            const capacityCard = document.getElementById('workloadCapacity').closest('.card-body');
            if (active.length >= maxCapacity) {
                capacityCard.parentElement.classList.add('border-danger');
            } else if (active.length >= maxCapacity * 0.8) {
                capacityCard.parentElement.classList.add('border-warning');
            }
            
            document.getElementById('agentOrdersTable').innerHTML = `
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Client</th>
                                <th>B&W</th>
                                <th>Color</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${orders.map(o => `
                                <tr class="clickable" onclick="viewOrderDetails(${o.id})">
                                    <td>#${o.id}</td>
                                    <td>${o.client_email || 'N/A'}</td>
                                    <td>${o.bw_quantity || o.bw_count || 0}</td>
                                    <td>${o.color_quantity || o.color_count || 0}</td>
                                    <td><span class="badge bg-${
                                        o.status === 'completed' ? 'success' : 
                                        o.status === 'processing' ? 'primary' : 
                                        o.status === 'validated' ? 'info' :
                                        'warning'
                                    }">${o.status}</span></td>
                                    <td>${new Date(o.created_at).toLocaleDateString()}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); viewOrderDetails(${o.id})">
                                            <i class="bi bi-eye"></i> View
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        } else {
            document.getElementById('activeOrdersCount').textContent = '0';
            document.getElementById('completedOrdersCount').textContent = '0';
            document.getElementById('workloadCapacity').textContent = '0/10';
            document.getElementById('agentOrdersTable').innerHTML = '<p class="text-muted">No orders assigned yet.</p>';
        }
    })
    .catch(error => {
        console.error('Error loading agent orders:', error);
        document.getElementById('agentOrdersTable').innerHTML = '<div class="alert alert-danger">Failed to load orders</div>';
    });
{% endif %}

{% if current_user.is_admin %}
// Load admin stats
console.log('Loading admin dashboard data...');

Promise.all([
    fetch('/api/users').then(r => r.json()),
    fetch('/api/orders').then(r => r.json()),
    fetch('/api/csv-imports').then(r => r.json())
]).then(([users, orders, csvs]) => {
    console.log('Users API response:', users);
    console.log('Orders API response:', orders);
    console.log('CSV API response:', csvs);
    
    // Extract data from wrapped response format { data: { items: [], pagination: {} } }
    const usersData = users.data || users;
    const ordersData = orders.data || orders;
    const csvsData = csvs.data || csvs;
    
    console.log('Users data:', usersData);
    console.log('Orders data:', ordersData);
    console.log('CSVs data:', csvsData);
    
    // Get arrays
    const usersArray = usersData.items || [];
    const ordersArray = ordersData.items || [];
    const csvsArray = csvsData.items || [];
    
    console.log('Users array length:', usersArray.length);
    console.log('Orders array length:', ordersArray.length);
    console.log('CSVs array length:', csvsArray.length);
    
    // Update stat cards
    const totalUsers = usersData.pagination?.total_items || usersArray.length;
    const totalOrders = ordersData.pagination?.total_items || ordersArray.length;
    
    document.getElementById('totalUsers').textContent = totalUsers;
    document.getElementById('totalOrders').textContent = totalOrders;
    document.getElementById('pendingCSV').textContent = csvsArray.filter(c => c.status === 'pending_validation').length || 0;
    document.getElementById('activeClients').textContent = usersArray.filter(u => u.role_name === 'Client' && u.is_active).length || 0;
    
    // Orders table
    if (ordersArray && ordersArray.length > 0) {
        document.getElementById('allOrdersTable').innerHTML = `
            <table class="table table-hover">
                <thead>
                    <tr><th>ID</th><th>Client</th><th>Agent</th><th>B&W</th><th>Color</th><th>Status</th><th>Created</th><th>Action</th></tr>
                </thead>
                <tbody>
                    ${ordersArray.map(o => `
                        <tr class="clickable" onclick="viewOrderDetails(${o.id})">
                            <td>#${o.id}</td>
                            <td>${o.client_email || 'N/A'}</td>
                            <td>${o.agent_email || 'Unassigned'}</td>
                            <td>${o.bw_quantity || o.bw_count || 0}</td>
                            <td>${o.color_quantity || o.color_count || 0}</td>
                            <td><span class="badge bg-${o.status === 'completed' ? 'success' : o.status === 'processing' ? 'primary' : 'warning'}">${o.status}</span></td>
                            <td>${new Date(o.created_at).toLocaleDateString()}</td>
                            <td><button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); viewOrderDetails(${o.id})"><i class="bi bi-eye"></i></button></td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    } else {
        document.getElementById('allOrdersTable').innerHTML = '<p class="text-muted">No orders found.</p>';
    }
    
    // Users table
    if (usersArray && usersArray.length > 0) {
        document.getElementById('usersTable').innerHTML = `
            <div class="table-responsive">
                <table class="table table-hover table-striped">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Email</th>
                            <th>Name</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Last Login</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${usersArray.map(u => `
                            <tr>
                                <td>${u.id}</td>
                                <td><i class="bi bi-envelope"></i> ${u.email}</td>
                                <td>${u.full_name || '<em class="text-muted">Not set</em>'}</td>
                                <td><span class="badge bg-${u.role_name === 'Administrator' ? 'danger' : u.role_name === 'Agent' ? 'info' : 'success'}">${u.role_name}</span></td>
                                <td><span class="badge bg-${u.is_active ? 'success' : 'secondary'}">${u.is_active ? 'Active' : 'Inactive'}</span></td>
                                <td><small>${u.created_at ? new Date(u.created_at).toLocaleDateString() : 'N/A'}</small></td>
                                <td><small>${u.last_login ? new Date(u.last_login).toLocaleString() : '<em class="text-muted">Never</em>'}</small></td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button class="btn btn-outline-primary" onclick="viewUser(${u.id})" title="View Details">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                        <button class="btn btn-outline-warning" onclick="editUser(${u.id})" title="Edit">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-outline-info" onclick="resetUserPassword(${u.id})" title="Reset Password">
                                            <i class="bi bi-key"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="deleteUser(${u.id}, '${u.email}')" 
                                                ${u.id === {{ current_user.id }} ? 'disabled title="Cannot delete yourself"' : 'title="Delete"'}>
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    } else {
        document.getElementById('usersTable').innerHTML = '<p class="text-muted">No users found.</p>';
    }
    
    // CSV Imports table
    if (csvsArray && csvsArray.length > 0) {
        document.getElementById('csvImportsTable').innerHTML = `
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Filename</th>
                        <th>Status</th>
                        <th>Uploaded By</th>
                        <th>Rows</th>
                        <th>Uploaded</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${csvsArray.map(csv => `
                        <tr>
                            <td>#${csv.id}</td>
                            <td>${csv.original_filename || 'N/A'}</td>
                            <td>
                                <span class="badge bg-${
                                    csv.status === 'validated' ? 'success' : 
                                    csv.status === 'rejected' ? 'danger' : 
                                    'warning'
                                }">
                                    ${csv.status.replace('_', ' ')}
                                </span>
                            </td>
                            <td>${csv.uploaded_by_email || 'N/A'}</td>
                            <td>
                                ${csv.row_count ? `
                                    <small>
                                        Total: ${csv.row_count}<br>
                                        Valid: ${csv.valid_rows || 0}<br>
                                        Errors: ${csv.error_rows || 0}
                                    </small>
                                ` : 'N/A'}
                            </td>
                            <td>${csv.uploaded_at ? new Date(csv.uploaded_at).toLocaleDateString() : 'N/A'}</td>
                            <td>
                                ${csv.status === 'pending_validation' ? `
                                    <button class="btn btn-sm btn-outline-success" onclick="reviewCsvImport(${csv.id})">
                                        <i class="bi bi-check-circle"></i> Review
                                    </button>
                                ` : `
                                    <button class="btn btn-sm btn-outline-info" onclick="viewCsvDetails(${csv.id})">
                                        <i class="bi bi-eye"></i> View
                                    </button>
                                `}
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    } else {
        document.getElementById('csvImportsTable').innerHTML = '<p class="text-muted">No CSV imports found.</p>';
    }
}).catch(error => {
    console.error('Error loading admin dashboard data:', error);
    document.getElementById('allOrdersTable').innerHTML = '<div class="alert alert-danger">Failed to load orders data</div>';
    document.getElementById('usersTable').innerHTML = '<div class="alert alert-danger">Failed to load users data</div>';
    document.getElementById('csvImportsTable').innerHTML = '<div class="alert alert-danger">Failed to load CSV imports data</div>';
});
{% endif %}

// User Management Functions using ModalManager
const userModals = new ModalManager();

function viewUser(userId) {
    fetch(`/api/users/${userId}`)
        .then(r => r.json())
        .then(response => {
            const user = response.data || response;
            
            // Populate view modal
            document.getElementById('viewUserId').textContent = user.id;
            document.getElementById('viewUserEmail').textContent = user.email;
            document.getElementById('viewUserName').textContent = user.full_name || 'Not set';
            document.getElementById('viewUserRole').textContent = user.role_name || 'N/A';
            
            const statusBadge = user.is_active 
                ? '<span class="badge bg-success">Active</span>' 
                : '<span class="badge bg-secondary">Inactive</span>';
            document.getElementById('viewUserStatus').innerHTML = statusBadge;
            
            document.getElementById('viewUserCreated').textContent = user.created_at 
                ? new Date(user.created_at).toLocaleString() 
                : 'N/A';
            document.getElementById('viewUserLastLogin').textContent = user.last_login 
                ? new Date(user.last_login).toLocaleString() 
                : 'Never';
            
            // Show modal
            userModals.show('userViewModal');
        })
        .catch(error => {
            console.error('Error fetching user:', error);
            Utils.showToast('Failed to load user details', 'error');
        });
}

function editUser(userId) {
    fetch(`/api/users/${userId}`)
        .then(r => r.json())
        .then(response => {
            const user = response.data || response;
            
            // Populate edit modal
            document.getElementById('editUserId').value = user.id;
            document.getElementById('editUserEmail').value = user.email;
            document.getElementById('editUserName').value = user.full_name || '';
            document.getElementById('editUserRole').value = user.role_name || 'Client';
            document.getElementById('editUserActive').checked = user.is_active;
            
            // Show modal
            userModals.show('userEditModal');
        })
        .catch(error => {
            console.error('Error fetching user:', error);
            Utils.showToast('Failed to load user details', 'error');
        });
}

// Handle edit user form submission
document.getElementById('editUserForm')?.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const userId = document.getElementById('editUserId').value;
    const formData = {
        full_name: document.getElementById('editUserName').value,
        role: document.getElementById('editUserRole').value,
        is_active: document.getElementById('editUserActive').checked
    };
    
    fetch(`/api/users/${userId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
    })
    .then(r => r.json())
    .then(result => {
        if (result.data) {
            Utils.showToast('User updated successfully!', 'success');
            userModals.hide('userEditModal');
            location.reload();
        } else {
            Utils.showToast(result.error?.message || 'Failed to update user', 'error');
        }
    })
    .catch(error => {
        console.error('Error updating user:', error);
        Utils.showToast('Failed to update user', 'error');
    });
});

function resetUserPassword(userId) {
    // Populate password reset modal
    document.getElementById('resetPasswordUserId').value = userId;
    document.getElementById('resetPasswordNew').value = '';
    document.getElementById('resetPasswordConfirm').value = '';
    
    // Show modal
    userModals.show('passwordResetModal');
}

// Handle password reset form submission
document.getElementById('passwordResetForm')?.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const userId = document.getElementById('resetPasswordUserId').value;
    const newPassword = document.getElementById('resetPasswordNew').value;
    const confirmPassword = document.getElementById('resetPasswordConfirm').value;
    
    if (newPassword !== confirmPassword) {
        Utils.showToast('Passwords do not match', 'error');
        return;
    }
    
    if (newPassword.length < 8) {
        Utils.showToast('Password must be at least 8 characters long', 'error');
        return;
    }
    
    fetch(`/api/users/${userId}/reset-password`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ new_password: newPassword })
    })
    .then(r => r.json())
    .then(result => {
        if (result.data || result.message) {
            Utils.showToast('Password reset successfully!', 'success');
            userModals.hide('passwordResetModal');
        } else {
            Utils.showToast(result.error?.message || 'Failed to reset password', 'error');
        }
    })
    .catch(error => {
        console.error('Error resetting password:', error);
        Utils.showToast('Failed to reset password', 'error');
    });
});

function deleteUser(userId, userEmail) {
    // Populate delete confirmation modal
    document.getElementById('deleteConfirmMessage').textContent = 
        `Are you sure you want to delete user "${userEmail}"? This will deactivate the user account.`;
    document.getElementById('deleteConfirmUserId').value = userId;
    
    // Show modal
    userModals.show('deleteConfirmModal');
}

// Handle delete confirmation
document.getElementById('confirmDeleteBtn')?.addEventListener('click', function() {
    const userId = document.getElementById('deleteConfirmUserId').value;
    
    fetch(`/api/users/${userId}`, {
        method: 'DELETE'
    })
    .then(r => r.json())
    .then(result => {
        if (result.data || result.message) {
            Utils.showToast('User deleted successfully!', 'success');
            userModals.hide('deleteConfirmModal');
            location.reload();
        } else {
            Utils.showToast(result.error?.message || 'Failed to delete user', 'error');
        }
    })
    .catch(error => {
        console.error('Error deleting user:', error);
        Utils.showToast('Failed to delete user', 'error');
    });
});

// Order Management Functions
const orderModals = new ModalManager();

function viewOrderDetails(orderId) {
    fetch(`/api/orders/${orderId}`)
        .then(r => r.json())
        .then(response => {
            const order = response.data || response;
            
            // Populate order view/edit modal
            document.getElementById('orderViewEditId').value = order.id;
            document.getElementById('orderViewEditClient').value = order.client_email || 'N/A';
            document.getElementById('orderViewEditAgent').value = order.agent_id || '';
            document.getElementById('orderViewEditBW').value = order.bw_quantity || 0;
            document.getElementById('orderViewEditColor').value = order.color_quantity || 0;
            document.getElementById('orderViewEditPaperDim').value = order.paper_dimensions || '';
            document.getElementById('orderViewEditPaperType').value = order.paper_type || '';
            document.getElementById('orderViewEditFinishing').value = order.finishing || '';
            document.getElementById('orderViewEditNotes').value = order.notes || '';
            
            const statusBadge = `<span class="badge bg-${
                order.status === 'completed' ? 'success' : 
                order.status === 'processing' ? 'primary' : 
                order.status === 'validated' ? 'info' : 'warning'
            }">${order.status}</span>`;
            document.getElementById('orderViewEditStatusDisplay').innerHTML = statusBadge;
            document.getElementById('orderViewEditStatus').value = order.status || 'pending';
            
            document.getElementById('orderViewEditCreated').textContent = Utils.formatDateTime(order.created_at);
            document.getElementById('orderViewEditUpdated').textContent = Utils.formatDateTime(order.updated_at);
            
            // Load agents for assignment dropdown
            loadAgentsForOrder(order.agent_id);
            
            // Show modal
            orderModals.show('orderViewEditModal');
        })
        .catch(error => {
            console.error('Error fetching order:', error);
            Utils.showToast('Failed to load order details', 'error');
        });
}

function loadAgentsForOrder(currentAgentId) {
    fetch('/api/users?role=Agent&is_active=true')
        .then(r => r.json())
        .then(response => {
            const users = response.data || response;
            const agents = users.items || users;
            
            const select = document.getElementById('orderViewEditAgent');
            select.innerHTML = '<option value="">Unassigned</option>';
            
            agents.forEach(agent => {
                const option = document.createElement('option');
                option.value = agent.id;
                option.textContent = `${agent.full_name || agent.email} (${agent.email})`;
                if (agent.id === currentAgentId) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error loading agents:', error);
        });
}

// Handle order status change
document.getElementById('saveOrderStatusBtn')?.addEventListener('click', function() {
    const orderId = document.getElementById('orderViewEditId').value;
    const newStatus = document.getElementById('orderViewEditStatus').value;
    
    fetch(`/api/orders/${orderId}/status`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: newStatus })
    })
    .then(r => r.json())
    .then(result => {
        if (result.data) {
            Utils.showToast('Order status updated successfully!', 'success');
            orderModals.hide('orderViewEditModal');
            location.reload();
        } else {
            Utils.showToast(result.error?.message || 'Failed to update order status', 'error');
        }
    })
    .catch(error => {
        console.error('Error updating order status:', error);
        Utils.showToast('Failed to update order status', 'error');
    });
});

// Handle agent assignment
document.getElementById('assignOrderAgentBtn')?.addEventListener('click', function() {
    const orderId = document.getElementById('orderViewEditId').value;
    const agentId = document.getElementById('orderViewEditAgent').value;
    
    const payload = agentId ? { agent_id: parseInt(agentId) } : { agent_id: null };
    
    fetch(`/api/orders/${orderId}/assign`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(result => {
        if (result.data) {
            const message = agentId ? 'Order assigned successfully!' : 'Order unassigned successfully!';
            Utils.showToast(message, 'success');
            orderModals.hide('orderViewEditModal');
            location.reload();
        } else {
            Utils.showToast(result.error?.message || 'Failed to assign order', 'error');
        }
    })
    .catch(error => {
        console.error('Error assigning order:', error);
        Utils.showToast('Failed to assign order', 'error');
    });
});

</script>
{% endblock %}
